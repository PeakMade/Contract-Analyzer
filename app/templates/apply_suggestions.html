{% extends "base.html" %}

{% block title %}Apply Suggestions - {{ contract_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Contract Analysis Results</h2>
            <p class="text-muted mb-0">
                <strong>Contract:</strong> {{ contract_name }}<br>
                <strong>Contract ID:</strong> {{ contract_id }}<br>
                {% if timestamp %}
                <strong>Analyzed:</strong> {{ timestamp }}
                {% endif %}
            </p>
        </div>
        <div>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Summary Banner -->
    {% if summary %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
            <strong>Analysis Summary:</strong> 
            {{ summary|selectattr('present', 'equalto', true)|list|length }} of {{ summary|length }} standards found
        </div>
        <div>
            <span class="badge bg-success me-2">
                {{ summary|selectattr('present', 'equalto', true)|list|length }} Found
            </span>
            <span class="badge bg-warning">
                {{ summary|rejectattr('present', 'equalto', true)|list|length }} Missing
            </span>
        </div>
    </div>
    {% endif %}

    <!-- Analysis Results Table -->
    {% if summary %}
    <form id="applySuggestionsForm" method="POST" action="{{ url_for('apply_suggestions_action', contract_id=contract_id) }}"
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Standards Analysis</h5>
                    <div>
                        <button type="button" id="selectAllBtn" class="btn btn-sm btn-light me-2">
                            Select All Missing
                        </button>
                        <button type="button" id="deselectAllBtn" class="btn btn-sm btn-outline-light">
                            Deselect All
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="5%" class="text-center">Apply</th>
                                <th width="20%">Standard</th>
                                <th width="10%" class="text-center">Present</th>
                                <th width="25%">Excerpt / Location</th>
                                <th width="40%">Suggestion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in summary %}
                            <tr class="{% if not item.present %}table-warning{% endif %}">
                                <!-- Apply Checkbox -->
                                <td class="text-center align-middle">
                                    {% if not item.present and item.suggestion and item.suggestion != 'N/A' %}
                                    <input type="checkbox" 
                                           class="form-check-input apply-checkbox" 
                                           name="apply_standards" 
                                           value="{{ item.standard }}"
                                           data-standard="{{ item.standard }}">
                                    {% else %}
                                    <span class="text-muted">â€”</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Standard Name -->
                                <td class="align-middle">
                                    <strong>{{ item.standard }}</strong>
                                    {% if item.source == 'sharepoint' %}
                                    <br><small class="text-muted">
                                        <i class="bi bi-building"></i> SharePoint Gold Standard
                                    </small>
                                    {% elif item.source == 'ai' %}
                                    <br><small class="text-muted">
                                        <i class="bi bi-robot"></i> AI Generated
                                    </small>
                                    {% endif %}
                                </td>
                                
                                <!-- Present Status -->
                                <td class="text-center align-middle">
                                    {% if item.present %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Yes
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-x-circle"></i> No
                                    </span>
                                    {% endif %}
                                </td>
                                
                                <!-- Excerpt / Location -->
                                <td class="align-middle">
                                    {% if item.present %}
                                        {% if item.excerpt and item.excerpt != 'N/A' %}
                                        <div class="small mb-1">
                                            <strong>Excerpt:</strong> 
                                            <em>"{{ item.excerpt[:150] }}{% if item.excerpt|length > 150 %}...{% endif %}"</em>
                                        </div>
                                        {% endif %}
                                        {% if item.location and item.location != 'N/A' %}
                                        <div class="small text-muted">
                                            <strong>Location:</strong> {{ item.location }}
                                        </div>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">Not found in contract</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Suggestion -->
                                <td class="align-middle">
                                    {% if item.suggestion and item.suggestion != 'N/A' %}
                                    <div class="small">
                                        {{ item.suggestion[:300] }}{% if item.suggestion|length > 300 %}...{% endif %}
                                    </div>
                                    {% if item.suggestion|length > 300 %}
                                    <button type="button" 
                                            class="btn btn-link btn-sm p-0 mt-1" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#suggestionModal{{ loop.index }}">
                                        View Full Text
                                    </button>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">No suggestion available</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <span id="selectedCount" class="text-muted">0 standards selected</span>
            </div>
            <div>
                <button type="submit" id="applySelectedBtn" class="btn btn-primary" disabled>
                    <i class="bi bi-check-square"></i> Apply Selected Suggestions
                </button>
            </div>
        </div>
    </form>
    {% else %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        No analysis results available for this contract.
    </div>
    {% endif %}
</div>

<!-- Modals for Full Suggestion Text -->
{% for item in summary %}
{% if item.suggestion and item.suggestion|length > 300 %}
<div class="modal fade" id="suggestionModal{{ loop.index }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ item.standard }} - Full Suggestion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    {% if item.source == 'sharepoint' %}
                    <i class="bi bi-building"></i> <strong>Source:</strong> SharePoint Gold Standard
                    {% else %}
                    <i class="bi bi-robot"></i> <strong>Source:</strong> AI Generated
                    {% endif %}
                </div>
                <p style="white-space: pre-wrap;">{{ item.suggestion }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.apply-checkbox');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const applyBtn = document.getElementById('applySelectedBtn');
    const selectedCount = document.getElementById('selectedCount');

    function updateSelectedCount() {
        const checkedCount = document.querySelectorAll('.apply-checkbox:checked').length;
        selectedCount.textContent = `${checkedCount} standard${checkedCount !== 1 ? 's' : ''} selected`;
        applyBtn.disabled = checkedCount === 0;
    }

    // Select all missing standards
    selectAllBtn.addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = true);
        updateSelectedCount();
    });

    // Deselect all
    deselectAllBtn.addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = false);
        updateSelectedCount();
    });

    // Update count on checkbox change
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });

    // Form submission confirmation
    document.getElementById('applySuggestionsForm').addEventListener('submit', function(e) {
        const checkedCount = document.querySelectorAll('.apply-checkbox:checked').length;
        if (checkedCount === 0) {
            e.preventDefault();
            alert('Please select at least one standard to apply.');
            return;
        }
        
        if (!confirm(`Are you sure you want to apply ${checkedCount} selected suggestion${checkedCount !== 1 ? 's' : ''} to this contract?`)) {
            e.preventDefault();
        }
    });

    // Initial count update
    updateSelectedCount();
});
</script>
{% endblock %}
