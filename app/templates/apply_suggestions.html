{% extends "base.html" %}

{% block title %}Apply Suggestions - {{ contract_name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>Contract Analysis Results</h2>
            <p class="text-muted mb-0">
                <strong>Contract:</strong> {{ contract_name }}<br>
                <strong>Contract ID:</strong> {{ contract_id }}<br>
                {% if timestamp %}
                <strong>Analyzed:</strong> {{ timestamp }}
                {% endif %}
            </p>
        </div>
        <div>
            <a href="{{ url_for('index') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Summary Banner -->
    {% if summary %}
    <div class="alert alert-info d-flex justify-content-between align-items-center">
        <div>
            <strong>Analysis Summary:</strong> 
            {{ summary|selectattr('present', 'equalto', true)|list|length }} of {{ summary|length }} standards found
        </div>
        <div>
            <span class="badge bg-success me-2">
                {{ summary|selectattr('present', 'equalto', true)|list|length }} Found
            </span>
            <span class="badge bg-warning">
                {{ summary|rejectattr('present', 'equalto', true)|list|length }} Missing
            </span>
        </div>
    </div>
    {% endif %}

    <!-- Analysis Results Table -->
    {% if summary %}
    <form id="applySuggestionsForm" method="POST" action="{{ url_for('apply_suggestions_action', contract_id=contract_id) }}"
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Standards Analysis</h5>
                    <div>
                        <button type="button" id="selectAllBtn" class="btn btn-sm btn-light me-2">
                            Select All Missing
                        </button>
                        <button type="button" id="deselectAllBtn" class="btn btn-sm btn-outline-light me-2">
                            Deselect All
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th width="5%" class="text-center">Apply</th>
                                <th width="20%">Standard</th>
                                <th width="10%" class="text-center">Present</th>
                                <th width="25%">Excerpt / Location</th>
                                <th width="40%">Suggestion</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in summary %}
                            <tr class="{% if not item.present %}table-warning{% endif %}">
                                <!-- Apply Checkbox -->
                                <td class="text-center align-middle">
                                    {% if not item.present and item.suggestion and item.suggestion != 'N/A' %}
                                    <input type="checkbox" 
                                           class="form-check-input apply-checkbox" 
                                           name="apply_standards" 
                                           value="{{ item.standard }}"
                                           data-standard="{{ item.standard }}">
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Standard Name -->
                                <td class="align-middle">
                                    <strong>{{ item.standard }}</strong>
                                    {% if item.source == 'sharepoint' %}
                                    <br><small class="text-success fw-bold">
                                        <i class="bi bi-check-circle"></i> Preferred Clause
                                    </small>
                                    {% elif item.source == 'ai' %}
                                    <br><small class="text-muted">
                                        <i class="bi bi-robot"></i> Custom Standard
                                    </small>
                                    {% endif %}
                                </td>
                                
                                <!-- Present Status -->
                                <td class="text-center align-middle">
                                    {% if item.present %}
                                    <span class="badge bg-success">
                                        <i class="bi bi-check-circle"></i> Yes
                                    </span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">
                                        <i class="bi bi-x-circle"></i> No
                                    </span>
                                    {% endif %}
                                </td>
                                
                                <!-- Excerpt / Location -->
                                <td class="align-middle">
                                    {% if item.present %}
                                        {% if item.excerpt and item.excerpt != 'N/A' %}
                                        <div class="small mb-1">
                                            <strong>Excerpt:</strong> 
                                            <em>"{{ item.excerpt[:150] }}{% if item.excerpt|length > 150 %}...{% endif %}"</em>
                                        </div>
                                        {% endif %}
                                        {% if item.location and item.location != 'N/A' %}
                                        <div class="small text-muted">
                                            <strong>Location:</strong> {{ item.location }}
                                        </div>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">Not found in contract</span>
                                    {% endif %}
                                </td>
                                
                                <!-- Suggestion -->
                                <td class="align-middle" data-full-suggestion="{{ item.suggestion }}">
                                    {% if item.suggestion and item.suggestion != 'N/A' %}
                                    <div class="small">
                                        {{ item.suggestion[:300] }}{% if item.suggestion|length > 300 %}...{% endif %}
                                    </div>
                                    {% if item.suggestion|length > 300 %}
                                    <button type="button" 
                                            class="btn btn-link btn-sm p-0 mt-1" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#suggestionModal{{ loop.index }}">
                                        View Full Text
                                    </button>
                                    {% endif %}
                                    {% else %}
                                    <span class="text-muted">No suggestion available</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Selection Count -->
        <div class="mb-4">
            <span id="selectedCount" class="text-muted">0 standards selected</span>
        </div>
        
        <!-- Sticky Apply Button -->
        <button type="submit" id="applySelectedBtn" class="btn btn-success sticky-apply-btn" disabled>
            <i class="bi bi-check-square"></i> Apply Selected
        </button>
    </form>
    {% else %}
    <div class="alert alert-warning">
        <i class="bi bi-exclamation-triangle"></i>
        No analysis results available for this contract.
    </div>
    {% endif %}
</div>

<!-- Modals for Full Suggestion Text -->
{% for item in summary %}
{% if item.suggestion and item.suggestion|length > 300 %}
<div class="modal fade" id="suggestionModal{{ loop.index }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ item.standard }} - Full Suggestion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    {% if item.source == 'sharepoint' %}
                    <i class="bi bi-building"></i> <strong>Source:</strong> SharePoint Gold Standard
                    {% else %}
                    <i class="bi bi-robot"></i> <strong>Source:</strong> AI Generated
                    {% endif %}
                </div>
                <p style="white-space: pre-wrap;">{{ item.suggestion }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endfor %}

<style>
/* Sticky Apply Button */
.sticky-apply-btn {
    position: fixed;
    bottom: 30px;
    right: 30px;
    z-index: 999;
    padding: 12px 24px;
    font-size: 1rem;
    font-weight: 600;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    border-radius: 8px;
    transition: all 0.3s ease;
}

.sticky-apply-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.4);
}

.sticky-apply-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .sticky-apply-btn {
        bottom: 20px;
        right: 20px;
        padding: 10px 20px;
        font-size: 0.9rem;
    }
}
</style>

<!-- Download Ready Modal -->
<div class="modal fade" id="downloadReadyModal" tabindex="-1" aria-labelledby="downloadReadyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="downloadReadyModalLabel">
                    <i class="bi bi-check-circle-fill me-2"></i>Document Ready
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="bi bi-file-earmark-check" style="font-size: 3rem; color: #28a745;"></i>
                </div>
                <h6 class="mb-3">Suggestions Applied Successfully!</h6>
                <p class="text-muted mb-2" id="downloadModalMessage">
                    <!-- Dynamic message inserted here -->
                </p>
                <p class="mb-4">
                    <strong id="downloadModalFilename" style="color: #495057;"></strong>
                </p>
                <div class="alert alert-info small mb-0">
                    <i class="bi bi-cloud-upload"></i> Document has been automatically uploaded to SharePoint
                </div>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="downloadModalBtn">
                    <i class="bi bi-download me-2"></i>Download Document
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Function to show download modal
function showDownloadModal(downloadUrl, filename, standardsApplied) {
    // Update modal content
    const messageEl = document.getElementById('downloadModalMessage');
    const filenameEl = document.getElementById('downloadModalFilename');
    const downloadBtn = document.getElementById('downloadModalBtn');
    
    messageEl.textContent = `Successfully applied ${standardsApplied} standard${standardsApplied !== 1 ? 's' : ''} to your contract.`;
    filenameEl.textContent = filename;
    
    // Set up download button
    downloadBtn.onclick = function() {
        window.location.href = downloadUrl;
        // Close modal after initiating download
        setTimeout(() => {
            bootstrap.Modal.getInstance(document.getElementById('downloadReadyModal')).hide();
        }, 500);
    };
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('downloadReadyModal'));
    modal.show();
}

document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.apply-checkbox');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const deselectAllBtn = document.getElementById('deselectAllBtn');
    const applyBtn = document.getElementById('applySelectedBtn');
    const selectedCount = document.getElementById('selectedCount');
    const form = document.getElementById('applySuggestionsForm');

    function updateSelectedCount() {
        const checkedCount = document.querySelectorAll('.apply-checkbox:checked').length;
        selectedCount.textContent = `${checkedCount} standard${checkedCount !== 1 ? 's' : ''} selected`;
        applyBtn.disabled = checkedCount === 0;
    }

    // Select all missing standards
    selectAllBtn.addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = true);
        updateSelectedCount();
    });

    // Deselect all
    deselectAllBtn.addEventListener('click', function() {
        checkboxes.forEach(cb => cb.checked = false);
        updateSelectedCount();
    });

    // Update count on checkbox change
    checkboxes.forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });

    // Form submission - POST JSON and trigger download
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const checkedCount = document.querySelectorAll('.apply-checkbox:checked').length;
        if (checkedCount === 0) {
            alert('Please select at least one standard to apply.');
            return;
        }
        
        if (!confirm(`Apply ${checkedCount} selected suggestion${checkedCount !== 1 ? 's' : ''} to this contract?\n\nThis will create an edited document with an appendix containing the suggested standards.`)) {
            return;
        }
        
        // Disable button and show loading state
        applyBtn.disabled = true;
        const originalText = applyBtn.innerHTML;
        applyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
        
        // Gather selected standards with their suggestions
        const selectedItems = [];
        checkboxes.forEach(cb => {
            if (cb.checked) {
                const row = cb.closest('tr');
                const standard = cb.dataset.standard || cb.value;
                
                // Get full suggestion text from data attribute
                const suggestionCell = row.querySelector('td[data-full-suggestion]');
                let suggestion = 'No suggestion available';
                if (suggestionCell) {
                    suggestion = suggestionCell.dataset.fullSuggestion || suggestion;
                }
                
                selectedItems.push({
                    standard: standard,
                    suggestion: suggestion
                });
            }
        });
        
        // POST JSON to backend
        const contractId = '{{ contract_id }}';
        fetch(`/contracts/${contractId}/apply_suggestions`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                items: selectedItems
            })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    throw new Error(data.message || data.error || 'Application failed');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.download_url) {
                // Show modal with download button instead of auto-download
                showDownloadModal(data.download_url, data.filename, data.standards_applied);
                
                // Reset button
                applyBtn.innerHTML = originalText;
                applyBtn.disabled = false;
            } else {
                throw new Error('Invalid response from server');
            }
        })
        .catch(error => {
            console.error('Error applying suggestions:', error);
            
            // Check if session expired
            if (error.message.includes('Session expired') || error.message.includes('sign in')) {
                alert('⚠️ Your session has expired. Please sign in again.');
                window.location.href = '/login';
            } else {
                alert(`❌ Error applying suggestions:\n\n${error.message}`);
            }
            
            // Reset button
            applyBtn.innerHTML = originalText;
            applyBtn.disabled = false;
        });
    });

    // Initial count update
    updateSelectedCount();
});
</script>
{% endblock %}
