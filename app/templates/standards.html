{% extends "base.html" %}
{% block title %}Contract Standards - {{ contract_name }}{% endblock %}

{% block content %}
<div class="card contract-portal">
  <div style="position: relative; margin-bottom: 10px;">
    <h1 style="text-align:center; color: #495057; margin-bottom:0; font-size:1.5rem; letter-spacing:1px;">
      {{ contract_name }}
    </h1>
    <a href="{{ url_for('index') }}?tab=dashboard"
      style="position: absolute; top: 0; right: 280px; z-index: 999; background: #6c757d; color: white; text-decoration: none; padding: 8px 14px; border-radius: 6px; font-size: 13px; font-weight: 500; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #6c757d; display: flex; align-items: center; height: fit-content;">
      Return to Dashboard
    </a>
  </div>

  <!-- Flash Messages Banner -->
  {% with messages = get_flashed_messages(with_categories=True) %}
    {% if messages %}
      <div style="margin: 10px 0;">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }}" style="padding: 8px 15px; margin-bottom: 8px; border-radius: 6px; 
               {% if category == 'success' %}background: #d4edda; color: #155724; border: 1px solid #c3e6cb;
               {% elif category == 'error' %}background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
               {% elif category == 'warning' %}background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;
               {% else %}background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb;{% endif %}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  {% if analysis_completed and summary %}
  <!-- Analysis Results Section -->
  <div class="analysis-results" style="margin: 10px 0;">
    <!-- Summary Counts Banner -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 20px; border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
      <h3 style="margin: 0 0 8px 0; font-weight: 600; font-size: 1.1rem;">Analysis Complete</h3>
      <div style="display: flex; gap: 30px; font-size: 1.1rem;">
        {% set present_count = summary | selectattr('present', 'equalto', true) | list | length %}
        {% set missing_count = summary | rejectattr('present', 'equalto', true) | list | length %}
        <div>
          <strong>{{ present_count }}</strong> of <strong>{{ summary | length }}</strong> standards found
        </div>
        <div>
          <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px;">
            ✓ {{ present_count }} Present
          </span>
          <span style="background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; margin-left: 10px;">
            ✗ {{ missing_count }} Missing
          </span>
        </div>
      </div>
    </div>

    <!-- Results Table -->
    <form method="POST" action="{{ url_for('apply_suggestions_action', contract_id=contract_id) }}" id="applySuggestionsForm">
      <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
        <div>
          <button type="button" id="applyAllBtn" class="btn-action" 
                  style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 500; cursor: pointer; margin-right: 10px;">
            Apply All Missing
          </button>
          <button type="submit" id="applySelectedBtn" class="btn-action" 
                  style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-weight: 500; cursor: pointer;" 
                  disabled>
            Apply Selected (<span id="selectedCount">0</span>)
          </button>
        </div>
        <span id="selectionStatus" style="color: #6c757d; font-size: 0.9rem;">Select standards to apply suggestions</span>
      </div>

      <div style="overflow-x: auto; border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        <table style="width: 100%; border-collapse: collapse; background: white;">
          <thead>
            <tr style="background: linear-gradient(135deg, #495057 0%, #343a40 100%); color: white;">
              <th style="padding: 8px; text-align: center; font-weight: 600; width: 60px; font-size: 0.9rem;">Apply</th>
              <th style="padding: 8px; text-align: left; font-weight: 600; width: 20%; font-size: 0.9rem;">Standard</th>
              <th style="padding: 8px; text-align: center; font-weight: 600; width: 10%; font-size: 0.9rem;">Present</th>
              <th style="padding: 8px; text-align: left; font-weight: 600; width: 30%; font-size: 0.9rem;">Excerpt / Location</th>
              <th style="padding: 8px; text-align: left; font-weight: 600; width: 40%; font-size: 0.9rem;">Suggestion</th>
            </tr>
          </thead>
          <tbody>
            {% for item in summary %}
            <tr style="border-bottom: 1px solid #dee2e6; {% if not item.present %}background: #fff3cd;{% endif %}">
              <!-- Apply Checkbox -->
              <td style="padding: 10px; text-align: center;">
                {% if not item.present %}
                  <input type="checkbox" name="apply_standards" value="{{ item.standard }}" class="apply-checkbox"
                         style="transform: scale(1.3); cursor: pointer;">
                {% else %}
                  <span style="color: #6c757d;">—</span>
                {% endif %}
              </td>

              <!-- Standard Name -->
              <td style="padding: 10px;">
                <strong style="color: #495057; font-size: 0.9rem;">{{ item.standard }}</strong>
                {% if item.source == 'sharepoint' %}
                  <br><small style="color: #28a745; font-weight: 600; font-size: 0.75rem;"><i class="bi bi-check-circle"></i> Preferred Clause</small>
                {% elif item.source == 'ai' %}
                  <br><small style="color: #6c757d; font-size: 0.75rem;"><i class="bi bi-robot"></i> Custom Standard</small>
                {% endif %}
              </td>

              <!-- Present Status -->
              <td style="padding: 10px; text-align: center;">
                {% if item.present %}
                  <span style="background: #28a745; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                    ✓ Yes
                  </span>
                {% else %}
                  <span style="background: #ffc107; color: #000; padding: 4px 12px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                    ✗ No
                  </span>
                {% endif %}
              </td>

              <!-- Excerpt / Location -->
              <td style="padding: 10px; font-size: 0.85rem;">
                {% if item.present %}
                  {% if item.excerpt and item.excerpt != 'N/A' %}
                    <div style="margin-bottom: 8px;">
                      <strong>Excerpt:</strong><br>
                      <em style="color: #495057;">"{{ item.excerpt[:150] }}{% if item.excerpt|length > 150 %}...{% endif %}"</em>
                    </div>
                  {% endif %}
                  {% if item.location and item.location != 'N/A' %}
                    <div style="color: #6c757d;">
                      <strong>Location:</strong> {{ item.location }}
                    </div>
                  {% endif %}
                {% else %}
                  <span style="color: #856404; font-style: italic;">Not found in contract</span>
                {% endif %}
              </td>

              <!-- Suggestion -->
              <td style="padding: 10px; font-size: 0.85rem;">
                {% if item.suggestion and item.suggestion != 'N/A' %}
                  <div style="color: #495057; line-height: 1.5;">
                    {{ item.suggestion[:200] }}{% if item.suggestion|length > 200 %}...{% endif %}
                  </div>
                  {% if item.suggestion|length > 200 %}
                    <button type="button" class="view-full-btn" data-standard="{{ item.standard }}" data-suggestion="{{ item.suggestion }}"
                            style="background: #007bff; color: white; border: none; padding: 4px 10px; border-radius: 4px; font-size: 0.8rem; margin-top: 8px; cursor: pointer;">
                      View Full Text
                    </button>
                  {% endif %}
                {% else %}
                  <span style="color: #6c757d; font-style: italic;">No suggestion available</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </form>
  </div>

  {% else %}
  <!-- Standards selection form (shown when analysis not completed) -->
  <div class="analysis-prep">
    <form method="post" action="{{ url_for('analyze_contract', contract_id=contract_id) }}" style="margin: 10px 0;">
      
      <!-- Default Standards Selection -->
      <div class="standards-selection" style="margin: 10px 0;">
        <h3 style="color: #495057; margin-bottom: 10px; font-weight: 600; font-size: 1.1rem;">
          Default Standards
          <button type="button" onclick="selectAllStandards()" class="select-all-btn-immediate"
            style="margin-left: 15px !important; padding: 5px 12px !important; background: var(--peakmade-magenta) !important; color: white !important; border: none !important; border-radius: 4px !important; font-size: 0.8rem !important; cursor: pointer !important; font-weight: 600 !important; text-transform: uppercase !important;">
            SELECT ALL
          </button>
          <button type="button" onclick="deselectAllStandards()" class="deselect-all-btn-immediate"
            style="margin-left: 8px !important; padding: 5px 12px !important; background: #6c757d !important; color: white !important; border: none !important; border-radius: 4px !important; font-size: 0.8rem !important; cursor: pointer !important; font-weight: 600 !important; text-transform: uppercase !important;">
            DESELECT ALL
          </button>
        </h3>

        <!-- Main container with standards grid and custom standards side by side -->
        <div style="display: flex; gap: 20px; align-items: flex-start;" class="standards-layout-container">

          <!-- Left side: Standards Grid (4 columns x 5 rows) -->
          <div class="standards-container"
            style="flex: 2; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; background: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div class="standards-grid"
              style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
              {% for item in preferred_standards %}
              <label
                style="display: flex; align-items: center; justify-content: flex-start; padding: 8px; background: white; border-radius: 6px; border: 1px solid #dee2e6; cursor: pointer; transition: all 0.2s ease; min-height: 40px;">
                <input type="checkbox" name="standards" value="{{ item.standard }}" checked
                  style="margin-right: 8px; transform: scale(1.1);">
                <span style="font-weight: 500; color: #495057; font-size: 0.85rem;">{{ item.standard }}</span>
              </label>
              {% endfor %}
            </div>
          </div>

          <!-- Right side: Custom Standards Section -->
          <div class="custom-standards-section"
            style="flex: 1; min-width: 280px; border: 2px solid #e9ecef; border-radius: 8px; padding: 12px; background: #f8f9fa; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h4
              style="color: #495057; margin-bottom: 10px; font-weight: 600; font-size: 1rem; text-align: center; margin-top: 0;">
              Add Custom Standards</h4>

            <!-- Custom standards input -->
            <input type="text" id="custom-standard-input" placeholder="Enter a custom standard..."
              style="width: 100%; padding: 10px; margin-bottom: 10px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 0.85rem; font-family: inherit; box-sizing: border-box; background: white;"
              onfocus="this.style.borderColor='#495057'" onblur="this.style.borderColor='#e0e0e0'">

            <!-- Add Standard button -->
            <button type="button" id="add-custom-standard"
              style="width: 130px; background: #495057; color: white; border: none; padding: 6px 10px; border-radius: 4px; font-weight: 500; cursor: pointer; font-size: 0.8rem; box-sizing: border-box; transition: all 0.2s ease;">
              Add Standard
            </button>
          </div>

        </div>
      </div>

      <!-- Centered Run AI Analysis Button -->
      <div style="margin: 20px 0 10px 0; text-align: center;">
        <button type="submit" id="analyze-button"
          style="display: inline-block; background: linear-gradient(135deg, #6c757d, #545b62); border: none; font-weight: 600; padding: 12px 40px; color: white; border-radius: 4px; cursor: pointer; font-size: 1rem;">
          <i class="fas fa-brain" style="margin-right: 8px;"></i>RUN AI ANALYSIS
        </button>
      </div>

    </form>
  </div>

  {% endif %}
  {# End of analysis_completed conditional #}
</div>

<!-- AI Analysis Loading Overlay -->
<div id="analysisLoadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 9999; justify-content: center; align-items: center;">
  <div style="text-align: center; color: white;">
    <!-- Spinning Wheel -->
    <div class="spinner-wheel" style="margin: 0 auto 30px; width: 80px; height: 80px; border: 8px solid rgba(255, 255, 255, 0.2); border-top: 8px solid #e6007e; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    
    <!-- Message -->
    <h2 style="font-size: 1.8rem; font-weight: 600; margin-bottom: 15px; color: white;">Hang Tight!</h2>
    <p style="font-size: 1.1rem; color: rgba(255, 255, 255, 0.9);">AI analysis in progress... This may take a while.</p>
    
    <!-- Progress Dots -->
    <div class="loading-dots" style="margin-top: 20px; font-size: 2rem; letter-spacing: 5px;">
      <span style="animation: blink 1.4s infinite both; animation-delay: 0s;">.</span><span style="animation: blink 1.4s infinite both; animation-delay: 0.2s;">.</span><span style="animation: blink 1.4s infinite both; animation-delay: 0.4s;">.</span>
    </div>
  </div>
</div>

<!-- Download Ready Modal -->
<div class="modal fade" id="downloadReadyModal" tabindex="-1" aria-labelledby="downloadReadyModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white;">
        <h5 class="modal-title" id="downloadReadyModalLabel">
          <i class="bi bi-check-circle-fill me-2"></i>Document Ready
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center py-4">
        <div class="mb-3">
          <i class="bi bi-file-earmark-check" style="font-size: 3rem; color: #28a745;"></i>
        </div>
        <h6 class="mb-3">Suggestions Applied Successfully!</h6>
        <p class="text-muted mb-2" id="downloadModalMessage">
          <!-- Dynamic message inserted here -->
        </p>
        <p class="mb-4">
          <strong id="downloadModalFilename" style="color: #495057;"></strong>
        </p>
      </div>
      <div class="modal-footer justify-content-center">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-success" id="downloadModalBtn">
          <i class="bi bi-download me-2"></i>Download Document
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// Function to show download modal
function showDownloadModal(downloadUrl, filename, standardsApplied) {
  // Update modal content
  const messageEl = document.getElementById('downloadModalMessage');
  const filenameEl = document.getElementById('downloadModalFilename');
  const downloadBtn = document.getElementById('downloadModalBtn');
  
  messageEl.textContent = `Successfully applied ${standardsApplied} standard${standardsApplied !== 1 ? 's' : ''} to your contract.`;
  filenameEl.textContent = filename;
  
  // Set up download button
  downloadBtn.onclick = function() {
    // Trigger download
    const link = document.createElement('a');
    link.href = downloadUrl;
    link.download = filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    // Close modal and redirect to dashboard
    const modalEl = document.getElementById('downloadReadyModal');
    const modalInstance = bootstrap.Modal.getInstance(modalEl);
    if (modalInstance) {
      modalInstance.hide();
    }
    
    // Redirect to dashboard after brief delay to ensure download starts
    setTimeout(() => {
      window.location.href = '/';
    }, 500);
  };
  
  // Show the modal
  const modal = new bootstrap.Modal(document.getElementById('downloadReadyModal'));
  modal.show();
}
</script>

<script>
{% if analysis_completed and summary %}
// Analysis Results JavaScript
document.addEventListener('DOMContentLoaded', function() {
  const checkboxes = document.querySelectorAll('.apply-checkbox');
  const applyAllBtn = document.getElementById('applyAllBtn');
  const applySelectedBtn = document.getElementById('applySelectedBtn');
  const selectedCountSpan = document.getElementById('selectedCount');
  const selectionStatus = document.getElementById('selectionStatus');

  function updateSelectionUI() {
    const checkedCount = document.querySelectorAll('.apply-checkbox:checked').length;
    selectedCountSpan.textContent = checkedCount;
    applySelectedBtn.disabled = checkedCount === 0;
    
    if (checkedCount > 0) {
      selectionStatus.textContent = `${checkedCount} standard${checkedCount !== 1 ? 's' : ''} selected for application`;
      selectionStatus.style.color = '#28a745';
    } else {
      selectionStatus.textContent = 'Select standards to apply suggestions';
      selectionStatus.style.color = '#6c757d';
    }
  }

  // Apply All button
  applyAllBtn.addEventListener('click', function() {
    checkboxes.forEach(cb => cb.checked = true);
    updateSelectionUI();
  });

  // Checkbox change
  checkboxes.forEach(cb => {
    cb.addEventListener('change', updateSelectionUI);
  });

  // View Full Text buttons
  document.querySelectorAll('.view-full-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const standard = this.dataset.standard;
      const suggestion = this.dataset.suggestion;
      
      // Create modal
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;';
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 8px; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);';
      modalContent.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #dee2e6; padding-bottom: 15px;">
          <h3 style="margin: 0; color: #495057;">${standard}</h3>
          <button type="button" class="close-modal" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 600;">Close</button>
        </div>
        <div style="white-space: pre-wrap; line-height: 1.6; color: #495057;">${suggestion}</div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Close handlers
      modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
    });
  });

  // Form submission with AJAX and modal
  document.getElementById('applySuggestionsForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const checkedCount = document.querySelectorAll('.apply-checkbox:checked').length;
    if (checkedCount === 0) {
      alert('Please select at least one standard to apply.');
      return;
    }
    
    // Disable button and show loading state
    const applyBtn = applySelectedBtn;
    applyBtn.disabled = true;
    const originalText = applyBtn.innerHTML;
    applyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Processing...';
    
    // Gather selected standards with their suggestions
    const selectedItems = [];
    
    document.querySelectorAll('.apply-checkbox:checked').forEach(cb => {
      const row = cb.closest('tr');
      const standardName = cb.value;
      
      // Find the suggestion in the row
      const suggestionCell = row.cells[4]; // 5th column is suggestion
      let suggestionText = 'N/A';
      
      // Try to get suggestion from view-full-btn data attribute
      const viewBtn = suggestionCell.querySelector('.view-full-btn');
      if (viewBtn && viewBtn.dataset.suggestion) {
        suggestionText = viewBtn.dataset.suggestion;
      } else {
        // Get text content and clean it up
        const textContent = suggestionCell.textContent.trim();
        if (textContent && textContent !== 'No suggestion available') {
          suggestionText = textContent.replace(/View Full Text$/, '').trim();
        }
      }
      
      selectedItems.push({
        standard: standardName,
        suggestion: suggestionText
      });
    });
    
    // POST JSON to backend
    const contractId = '{{ contract_id }}';
    fetch(`/contracts/${contractId}/apply_suggestions`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        items: selectedItems
      })
    })
    .then(response => {
      if (!response.ok) {
        return response.json().then(data => {
          throw new Error(data.message || data.error || 'Application failed');
        });
      }
      return response.json();
    })
    .then(data => {
      if (data.success && data.download_url) {
        // Show modal with download button
        showDownloadModal(data.download_url, data.filename, data.standards_applied);
        
        // Reset button
        applyBtn.innerHTML = originalText;
        applyBtn.disabled = false;
      } else {
        throw new Error('Invalid response from server');
      }
    })
    .catch(error => {
      console.error('Error applying suggestions:', error);
      
      // Check if session expired
      if (error.message.includes('Session expired') || error.message.includes('sign in')) {
        alert('⚠️ Your session has expired. Please sign in again.');
        window.location.href = '/login';
      } else {
        alert(`❌ Error applying suggestions:\n\n${error.message}`);
      }
      
      // Reset button
      applyBtn.innerHTML = originalText;
      applyBtn.disabled = false;
    });
  });

  // Initial UI update
  updateSelectionUI();
});
{% else %}
// Standards Selection JavaScript (original functionality)
{% endif %}

// Global functions for Select All / Deselect All
function selectAllStandards() {
  console.log('Selecting all standards');
  const allCheckboxes = document.querySelectorAll('input[name="standards"]');
  allCheckboxes.forEach(cb => cb.checked = true);
}

function deselectAllStandards() {
  console.log('Deselecting all standards');
  const allCheckboxes = document.querySelectorAll('input[name="standards"]');
  allCheckboxes.forEach(cb => cb.checked = false);
}

// Custom standard functionality
function addCustomStandard() {
  console.log('Adding custom standard');
  const input = document.getElementById('custom-standard-input');
  const standardText = input.value.trim();

  if (!standardText) {
    alert('Please enter a standard before adding.');
    return;
  }

  // Check if standard already exists
  const existingCheckboxes = document.querySelectorAll('input[name="standards"]');
  const exists = Array.from(existingCheckboxes).some(cb => cb.value.toLowerCase() === standardText.toLowerCase());
  if (exists) {
    alert('This standard already exists in the list.');
    return;
  }

  // Add to grid
  const standardsGrid = document.querySelector('.standards-grid');
  const newLabel = document.createElement('label');
  newLabel.className = 'custom-standard';
  newLabel.style.cssText = 'display: flex; align-items: center; padding: 12px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #28a745; cursor: pointer;';
  newLabel.innerHTML = `
    <input type="checkbox" name="standards" value="${standardText}" checked 
           style="margin-right: 10px; transform: scale(1.2);">
    <span style="font-weight: 500;">${standardText}</span>
    <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem; margin-left: auto;">CUSTOM</span>
    <button type="button" class="remove-custom-standard" title="Remove this custom standard"
            style="background: #dc3545; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; margin-left: 8px; cursor: pointer;">×</button>
  `;

  standardsGrid.appendChild(newLabel);

  // Add remove button event
  const removeBtn = newLabel.querySelector('.remove-custom-standard');
  removeBtn.addEventListener('click', function(e) {
    e.stopPropagation();
    if (confirm('Remove this custom standard?')) {
      newLabel.remove();
    }
  });

  // Clear input
  input.value = '';

  // Show success message
  const msg = document.createElement('div');
  msg.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 1000; background: #28a745; color: white; padding: 12px 20px; border-radius: 8px;';
  msg.textContent = `✅ "${standardText}" added!`;
  document.body.appendChild(msg);
  setTimeout(() => msg.remove(), 3000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  const addButton = document.getElementById('add-custom-standard');
  const customInput = document.getElementById('custom-standard-input');

  if (addButton) {
    addButton.addEventListener('click', addCustomStandard);
  }

  if (customInput) {
    customInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addCustomStandard();
      }
    });
  }

  // Show loading overlay when AI analysis form is submitted
  const analysisForm = document.querySelector('form[action*="/analyze"]');
  if (analysisForm) {
    analysisForm.addEventListener('submit', function(e) {
      // Show the loading overlay
      const overlay = document.getElementById('analysisLoadingOverlay');
      if (overlay) {
        overlay.style.display = 'flex';
      }
      // Form will submit normally and redirect to results page
    });
  }
});
</script>

<style>
/* Loading Spinner Animations */
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes blink {
  0%, 80%, 100% { opacity: 0; }
  40% { opacity: 1; }
}

/* Standards selection styling */
.standards-selection label:hover {
  background: #e9ecef !important;
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
  transition: all 0.2s ease;
  border-color: #495057 !important;
}

.standards-selection input[type="checkbox"]:checked + span {
  color: #495057;
  font-weight: 700;
}

/* Custom standards specific styling */
.standards-grid label.custom-standard {
  background: #e8f5e8 !important;
  border-left-color: #28a745 !important;
}

.standards-grid label.custom-standard:hover {
  background: #d4f4d4 !important;
}

.btn-primary:hover {
  background: #c6045a !important;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.3) !important;
  transition: all 0.3s ease;
}

#add-custom-standard:hover {
  background: #343a40 !important;
  transform: translateY(-1px);
}

.remove-custom-standard:hover {
  background: #c82333 !important;
  transform: scale(1.1);
}

/* Responsive layout */
@media (max-width: 1200px) {
  .standards-layout-container {
    flex-direction: column !important;
  }
  
  .standards-grid {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}

@media (max-width: 768px) {
  .standards-grid {
    grid-template-columns: 1fr !important;
  }
}
</style>
{% endblock %}
